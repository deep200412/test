// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © deep200412

//@version=5
strategy("Donchian breakout", overlay=true)

donchLen = 40
donchLen1 = 60
pos = 20
target = 15

ema_200 = ta.ema(close, 200)
upperBand = ta.highest(high, donchLen)[1]
lowerBand = ta.lowest(low, donchLen)[1]
lowerBand1 = ta.lowest(low, donchLen1)[1]

plot(upperBand, color = color.green, linewidth = 2)
plot(lowerBand, color = color.black, linewidth = 2)
plot(lowerBand1, color = color.red, linewidth = 2)

startTime = timestamp(2022,1,1,0,0,0)
endTime = timestamp(2024,8,31,0,0,0)
tradeAllowed = true //bar_index > donchLen

var float buyPrice = 0

longCond = ( strategy.position_size == 0 ) and (high > upperBand + syminfo.mintick) and (close > ema_200 * 1.02) and (open < close)
shortCond = (strategy.position_size > 0) and (low < lowerBand1 - syminfo.mintick)
targetPrice = (strategy.position_size > 0  ? buyPrice * (1 + target/100.0) : na )

targetCond = (strategy.position_size >0) and (close >= targetPrice)

if(time > startTime and tradeAllowed)
    if (longCond)
        strategy.entry("Long", strategy.long,pos )
        //strategy.exit("SL Long", from_entry = "Long", stop = low * 0.95)

if (longCond[1])
    buyPrice := open


if (time > startTime and tradeAllowed)
    if (shortCond or targetCond)
        strategy.close("Long", comment = (targetCond ? "Target": "" ))
        buyPrice := na

if (time > endTime)
    strategy.close_all()


plot(buyPrice, color = color.lime)
plot(targetPrice, color = color.orange)

